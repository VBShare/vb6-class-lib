VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "CString"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Explicit
'//////////////////////////////////////////////////////////////////////////////
'@@summary
' ¹Â·« °æÈ¨ËùÓÐ2005 - 2006(C)
' SunSoft ËÑ¼¯ÕûºÏ£¬²¢½øÐÐ²¿·Öµ÷Õû
'@@require
'@@reference
'Õâ¸ö×Ö·û´®²Ù×÷ÀàµÄ×ÔÔö»º³åÇøµÄÌØµãÊÇ£ºµ±»º³åÇø²»¹»´óÊ±½«ÒÔ128£¨128*2£©µÄ´óÐ¡Ôö¼Ó»º³åÇø´óÐ¡
'@@license MIT
'@@version V1.1.0
'@@author
' Ô­´´£º¹Â·«
' ÐÞ¸Ä£ºSunSoft
'@@create
'2005-11-11 02:44:32
'@@modify
'2016-2-14 18:21:50
'1.Ôö¼ÓÄ¬ÈÏÊôÐÔ¹¦ÄÜ
'2.Ôö¼ÓAppendLine¹¦ÄÜ
'//////////////////////////////////////////////////////////////////////////////

'//////////////////////////////////////////////////////////////////////////////
'//
'//      ¹«ÓÐÉùÃ÷
'//
'//////////////////////////////////////////////////////////////////////////////


'------------------------------------------------------------------------------
'       ½Ó¿Ú¼Ì³Ð
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       ¹«ÓÐ³£Á¿
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       ¹«ÓÐÊý¾ÝÀàÐÍ
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       ¹«ÓÐ±äÁ¿
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       ¹«ÓÐAPI
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       ÊÂ¼þÉùÃ÷
'------------------------------------------------------------------------------


'//////////////////////////////////////////////////////////////////////////////
'//
'//      Ë½ÓÐÉùÃ÷
'//
'//////////////////////////////////////////////////////////////////////////////


'------------------------------------------------------------------------------
'       Ë½ÓÐ³£Á¿
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       Ë½ÓÐÊý¾ÝÀàÐÍ
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       Ë½ÓÐ±äÁ¿
'------------------------------------------------------------------------------
Private m_Buffer() As Byte   '»º³åÇø
Private m_lpBuffer As Long   '·ÖÅäµÄÄÚ´æ¿éÖ¸Õë

Private m_AllocSize As Long  'Êµ¼Ê·ÖÅäµÄÄÚ´æ´óÐ¡
Private m_Length As Long     'µ±Ç°ÒÑ¾­Ê¹ÓÃµÄÄÚ´æ´óÐ¡

Private nLen As Long 'ÐÂ¼ÓÈëµÄ×Ö·û´®³¤¶È
'------------------------------------------------------------------------------
'       ÊôÐÔ±äÁ¿
'------------------------------------------------------------------------------


'------------------------------------------------------------------------------
'       Ë½ÓÐAPI
'------------------------------------------------------------------------------
Private Declare Sub CopyMemory Lib "ntdll" Alias "RtlMoveMemory" _
                    (Destination As Any, Source As Any, ByVal Length As Long)

Private Declare Function StrCSpn Lib "shlwapi.dll" Alias "StrCSpnW" _
                        (ByVal lpStr&, ByVal lpCharacters&) As Long
Private Declare Function StrCSpnI Lib "shlwapi.dll" Alias "StrCSpnIW" _
                        (ByVal lpStr&, ByVal lpCharacters&) As Long

Private Declare Function StrRStr Lib "shell32.dll" Alias "StrRStrW" _
                        (ByVal lpStart&, ByVal lpEnd&, ByVal lpSrch&) As Long
Private Declare Function StrRStrI Lib "shell32.dll" Alias "StrRStrIW" _
                        (ByVal lpStart&, ByVal lpEnd&, ByVal lpSrch&) As Long

'//////////////////////////////////////////////////////////////////////////////
'//
'//      Àà
'//
'//////////////////////////////////////////////////////////////////////////////


'------------------------------------------------------------------------------
'       ³õÊ¼»¯
'------------------------------------------------------------------------------
Private Sub Class_Initialize()
  m_AllocSize = 0
  m_Length = 0
End Sub


'------------------------------------------------------------------------------
'       Ïú»Ù
'------------------------------------------------------------------------------
Private Sub Class_Terminate()
  Erase m_Buffer
End Sub


'//////////////////////////////////////////////////////////////////////////////
'//
'//      ÊÂ¼þ´¦Àí
'//
'//////////////////////////////////////////////////////////////////////////////


'//////////////////////////////////////////////////////////////////////////////
'//
'//      Ë½ÓÐÊôÐÔ
'//
'//////////////////////////////////////////////////////////////////////////////


'//////////////////////////////////////////////////////////////////////////////
'//
'//      Ë½ÓÐ·½·¨
'//
'//////////////////////////////////////////////////////////////////////////////


'//////////////////////////////////////////////////////////////////////////////
'//
'//      ¼Ì³ÐÊµÏÖ
'//
'//////////////////////////////////////////////////////////////////////////////


'//////////////////////////////////////////////////////////////////////////////
'//
'//      ¹«ÓÐÊôÐÔ
'//
'//////////////////////////////////////////////////////////////////////////////

'*************************************************************************
'   ÉèÖÃ»º³åÇøÈÝÁ¿´óÐ¡
'*************************************************************************
Public Property Let Capacity(ByVal Size As Long)
  If Size < 1 Then Exit Property

  Size = Size + Size 'ÓÉÓÚvbµÄ×Ö·û´®ÊÇBSTR×Ö·ûÕ¼2¸ö×Ö½ÚËùÒÔ·ÖÅä2±¶µÄÄÚ´æ
  If Size <= m_AllocSize Then Exit Property 'ÄÚ´æ¿é»¹¹»ÓÃ

  '   ·ÖÅäÒ»¸ö»º³åÇø
  If m_AllocSize = 0 Or m_Length = 0 Then 'Ã»ÓÐÊý¾Ý»ò»¹Ã»ÓÐ·ÖÅä¹ýÄÚ´æ
    ReDim m_Buffer(0 To Size)
  Else
    ReDim Preserve m_Buffer(0 To Size)
  End If
  m_lpBuffer = VarPtr(m_Buffer(0))        '»º³åÇøÖ¸Õë

  m_AllocSize = Size
End Property

'*************************************************************************
'   »ñÈ¡µ±Ç°×Ö·û´®³¤¶È
'*************************************************************************
Public Property Get Length() As Long
  Length = m_Length / 2
End Property

Public Property Get Value() As String
  Value = Me.ToString
End Property

Public Property Let Value(ByVal newValue As String)
Attribute Value.VB_UserMemId = 0
  Call Class_Initialize
  Call Append(newValue)
End Property

'//////////////////////////////////////////////////////////////////////////////
'//
'//      ¹«ÓÐ·½·¨
'//
'//////////////////////////////////////////////////////////////////////////////

'*************************************************************************
'   Çå¿ÕÊý¾Ý
'*************************************************************************
Public Sub Clear()
  m_Length = 0
End Sub

'*************************************************************************
'ÿ ÔÚ×Ö·û´®»º³åÇøµÄºóÃæÔö¼Ó×Ö·û´®
'   ²Î  Êý£ºÒªÔö¼ÓµÄ×Ö·û´®
'   ·µ»ØÖµ£ºÎÞ
'*************************************************************************
Public Sub Append(ByVal str As String)
  Const IncreaseStep = 128

  nLen = Len(str)
  nLen = nLen + nLen

  'Èç¹ûm_AllocSize <= m_Length + nLen£¬ÔòÒÔ 128+ nLen ¸ö×Ö·ûµÄÔöÁ¿Ôö¼ÓÄÚ´æ
  If m_AllocSize <= m_Length + nLen Then
      Me.Capacity = (m_Length + nLen) / 2 + IncreaseStep
  End If

  '¿½±´Êý¾Ýµ½»º³åÇø
  Call CopyMemory(ByVal (m_lpBuffer + m_Length), ByVal StrPtr(str), nLen)
  m_Length = m_Length + nLen
End Sub

Public Sub AppendLine(ByVal str As String)
  Call Append(vbCrLf & str)
End Sub

'*************************************************************************
'   Ñ°ÕÒ str ÔÚ»º³åÇøÖÐµÚÒ»´Î³öÏÖµÄÎ»ÖÃ(×Ö·ûÎ»ÖÃ´Ó 1 ÊýÆð)
'   ²Î  Êý£ºÒª²éÕÒµÄ×Ö·û´®,[ÊÇ·ñºöÊÓ´óÐ¡Ð´(Ä¬ÈÏºöÊÓ´óÐ¡Ð´)]
'   ·µ»ØÖµ£º³É¹¦Ôò²»Îª-1
'*************************************************************************
Public Function IndexOf(ByVal str As String, Optional ByVal IsIgnoreCase As Boolean = True) As Long
  If m_Length < 1 Then
    IndexOf = -1
    Exit Function
  End If

  If IsIgnoreCase Then
    IndexOf = StrCSpnI(m_lpBuffer, StrPtr(str))
  Else
    IndexOf = StrCSpn(m_lpBuffer, StrPtr(str))
  End If

  If IndexOf >= 0 Then IndexOf = IndexOf + 1
End Function

'*************************************************************************
'   Ñ°ÕÒ str ÔÚ»º³åÇøÖÐ×îºóÒ»´Î³öÏÖµÄÎ»ÖÃ(×Ö·ûÎ»ÖÃ´Ó 1 ÊýÆð)
'   ²Î  Êý£ºÒª²éÕÒµÄ×Ö·û´®,[ÊÇ·ñºöÊÓ´óÐ¡Ð´(Ä¬ÈÏºöÊÓ´óÐ¡Ð´)]
'   ·µ»ØÖµ£º³É¹¦Ôò²»Îª-1
'*************************************************************************
Public Function LastIndexOf(ByVal str As String, Optional ByVal IsIgnoreCase As Boolean = True) As Long
  If m_Length < 1 Then
    LastIndexOf = -1
    Exit Function
  End If

  If IsIgnoreCase Then
    LastIndexOf = StrRStrI(m_lpBuffer, m_lpBuffer + m_Length, StrPtr(str))
  Else
    LastIndexOf = StrRStr(m_lpBuffer, m_lpBuffer + m_Length, StrPtr(str))
  End If

  If LastIndexOf >= m_lpBuffer Then
    LastIndexOf = (LastIndexOf - m_lpBuffer) / 2 + 1
  Else
    LastIndexOf = -1
  End If
End Function

Public Function ToString() As String
  If m_Length > 1 Then
    ToString = Left(m_Buffer, m_Length / 2) '×¢Òâ²»ÒªÓÃLeft$
  Else
    ToString = ""
  End If
End Function

